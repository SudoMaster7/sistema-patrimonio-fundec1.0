{% extends "base.html" %}

{% block title %}Inventário — Registros{% endblock %}

{% block head %}
<style>
  /* CSS unificado e compatível com tema claro/escuro */
  :root {
    --bg: #f7f9fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --border: #e6eef8;
    --text: #0f172a;
    --input-bg: #ffffff;
    --table-header-color: #111827;
    --table-row-border: #f1f5f9;
  }

  [data-bs-theme="dark"] {
    --bg: #0d1117;
    --card: #161b22;
    --muted: #848d97;
    --border: #30363d;
    --text: #c9d1d9;
    --input-bg: #0d1117;
    --table-header-color: #ffffff;
    --table-row-border: var(--border);
  }

  body { background: var(--bg); color: var(--text); }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.04); }
  .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .info { color: var(--muted); font-size: 14px; }
  input.filter { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text); font-size: 13px; }
  .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; flex-wrap: wrap; gap: 8px; }
  .btn-row { display: flex; gap: 8px; align-items: center; }
  .btn-surface { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
  .disabled { opacity: 0.6; pointer-events: none; }
  
  /* Ajustes para a tabela com estilo Bootstrap */
  .table thead th { color: var(--table-header-color); }
  .table tbody td { border-bottom-color: var(--table-row-border); }
  .table-hover > tbody > tr:hover > * { --bs-table-hover-bg: rgba(0, 0, 0, 0.075); }
  [data-bs-theme="dark"] .table-hover > tbody > tr:hover > * { --bs-table-hover-bg: rgba(255, 255, 255, 0.075); }

</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="controls">
    <div class="info">Mostrando <strong id="shown-count">0</strong> de <strong id="total-count">0</strong> itens</div>
    <div style="flex:1"></div>
    <div class="btn-row">
      <button id="load-more" class="btn-surface" style="display:none">Ver mais</button>
      <button id="view-all" class="btn-surface" style="display:none">Ver toda a tabela</button>
    </div>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped table-hover align-middle" id="table-inv">
      <thead class="table-dark">
        <tr>
          <th>Unidade<br><input class="filter" data-col="unidade" placeholder="Filtrar..."></th>
          <th>Categoria<br><input class="filter" data-col="categoria" placeholder="Filtrar..."></th>
          <th>Marca<br><input class="filter" data-col="marca" placeholder="Filtrar..."></th>
          <th>N° de Série<br><input class="filter" data-col="n_serie" placeholder="Filtrar..."></th>
          <th>Estado<br><input class="filter" data-col="estado" placeholder="Filtrar..."></th>
          <th class="text-center" style="width: 100px;">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody-inv">
        </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Item (Linha <span id="modal-row-num"></span>)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm" onsubmit="event.preventDefault(); submitEditModal();">
                <div class="modal-body">
                    <input type="hidden" id="editRowId" name="row_number">
                    <div class="mb-3"><label for="editUnidade" class="form-label">Unidade</label><input type="text" class="form-control" id="editUnidade" name="unidade" required></div>
                    <div class="mb-3"><label for="editCategoria" class="form-label">Categoria</label><select class="form-select" id="editCategoria" name="categoria" required><option>Monitor</option><option>CPU</option><option>Teclado e Mouse</option><option>Estabilizador</option><option>Switch</option><option>Roteador</option><option>Impressora</option><option>Televisão</option><option>Projetor</option></select></div>
                    <div class="mb-3"><label for="editDescricao" class="form-label">Descrição</label><textarea class="form-control" id="editDescricao" name="descricao" rows="2"></textarea></div>
                    <div class="mb-3"><label for="editMarca" class="form-label">Marca</label><input type="text" class="form-control" id="editMarca" name="marca"></div>
                    <div class="mb-3"><label for="editNSerie" class="form-label">N° de Série</label><input type="text" class="form-control" id="editNSerie" name="n_serie" required></div>
                    <div class="mb-3"><label for="editEstado" class="form-label">Estado</label><select class="form-select" id="editEstado" name="estado" required><option>Novo</option><option>Seminovo</option><option>Inservível</option></select></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="edit-submit-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-text">Salvar Alterações</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Estado da aplicação
  let allItems = [];
  let currentOffset = 0;
  const BATCH_SIZE = 20;
  let totalServerCount = 0;
  let hasMoreOnServer = false;
  let editModalInstance = null;

  // Função central de erros
  function handleError(message, error) {
    console.error(message, error);
    alert(message);
  }

  // Busca os dados da API
  async function fetchItems(isInitialLoad = false) {
    if (isInitialLoad) document.getElementById('tbody-inv').innerHTML = '<tr><td colspan="6" class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
    try {
      const res = await fetch(`/api/items?offset=${currentOffset}&limit=${BATCH_SIZE}`);
      if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
      const data = await res.json();
      allItems = isInitialLoad ? (data.items || []) : allItems.concat(data.items || []);
      totalServerCount = data.total || 0;
      hasMoreOnServer = !!data.has_more;
      applyFilters();
      updateFooterUI();
    } catch (err) {
      handleError('Falha ao carregar itens.', err);
      document.getElementById('tbody-inv').innerHTML = '<tr><td colspan="6" class="text-center p-4 text-danger">Erro ao carregar dados. Tente novamente.</td></tr>';
    }
  }

  // Busca todos os itens da tabela
  async function fetchAllItems() {
    const btnAll = document.getElementById('view-all');
    const btnLoad = document.getElementById('load-more');
    btnAll.disabled = true;
    btnLoad.style.display = 'none';
    btnAll.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Carregando tudo...`;
    try {
      let allResults = [];
      let tempOffset = 0;
      const BATCH_SIZE_FOR_ALL = 200;
      while (true) {
        const res = await fetch(`/api/items?offset=${tempOffset}&limit=${BATCH_SIZE_FOR_ALL}`);
        if (!res.ok) throw new Error('Falha ao carregar uma página de dados.');
        const data = await res.json();
        allResults = allResults.concat(data.items || []);
        if (!data.has_more) break;
        tempOffset += BATCH_SIZE_FOR_ALL;
      }
      allItems = allResults;
      currentOffset = allResults.length;
      totalServerCount = allResults.length;
      hasMoreOnServer = false;
      document.querySelectorAll('input.filter').forEach(input => input.value = '');
      applyFilters();
      updateFooterUI();
    } catch (err) {
      handleError('Erro ao carregar a tabela completa.', err);
    } finally {
      btnAll.disabled = false;
      btnAll.innerHTML = 'Ver toda a tabela';
    }
  }

  function updateFooterUI() {
    document.getElementById('total-count').textContent = totalServerCount;
    document.getElementById('load-more').style.display = hasMoreOnServer ? 'inline-block' : 'none';
    document.getElementById('view-all').style.display = (hasMoreOnServer || allItems.length < totalServerCount) ? 'inline-block' : 'none';
  }

  function renderTable(list) {
    const tbody = document.getElementById('tbody-inv');
    document.getElementById('shown-count').textContent = list.length;
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhum item encontrado.</td></tr>';
      return;
    }
    const fragment = document.createDocumentFragment();
    list.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(item.unidade)}</td>
        <td>${escapeHtml(item.categoria)}</td>
        <td>${escapeHtml(item.marca)}</td>
        <td>${escapeHtml(item.n_serie)}</td>
        <td>${escapeHtml(item.estado)}</td>
        <td class="text-center">
          <button class="btn btn-warning btn-sm" onclick='openEditModal(${JSON.stringify(item)})'>
            <i class="fa-solid fa-pencil"></i> Editar
          </button>
        </td>
      `;
      fragment.appendChild(tr);
    });
    tbody.appendChild(fragment);
  }
  
  function escapeHtml(text) { return (text || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  function applyFilters() {
    const filters = Array.from(document.querySelectorAll('input.filter'));
    let filteredList = allItems;
    for (const f of filters) {
      const val = f.value.trim().toLowerCase();
      const col = f.dataset.col;
      if (val) {
        filteredList = filteredList.filter(item => (item[col] || '').toString().toLowerCase().includes(val));
      }
    }
    renderTable(filteredList);
  }

  // --- FUNÇÕES DO MODAL DE EDIÇÃO ---

  /**
   * CORREÇÃO APLICADA AQUI
   */
  function openEditModal(item) {
    if (!item) return handleError('Item não encontrado.');
    
    const form = document.getElementById('editForm');
    
    // Procura os elementos no formulário
    form.querySelector('#editRowId').value = item.row_number;
    form.querySelector('#editUnidade').value = item.unidade || '';
    form.querySelector('#editCategoria').value = item.categoria || '';
    form.querySelector('#editDescricao').value = item.descricao || '';
    form.querySelector('#editMarca').value = item.marca || '';
    form.querySelector('#editNSerie').value = item.n_serie || '';
    form.querySelector('#editEstado').value = item.estado || '';
    
    // CORREÇÃO: Procura o span do título no DOCUMENTO INTEIRO, não apenas dentro do form.
    document.getElementById('modal-row-num').textContent = item.row_number;
    
    editModalInstance.show();
  }

  async function submitEditModal() {
    const btn = document.getElementById('edit-submit-btn');
    const spinner = btn.querySelector('.spinner-border');
    const btnText = btn.querySelector('.button-text');
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    btnText.textContent = 'Salvando...';

    const form = document.getElementById('editForm');
    const payload = {
        row_number: Number(form.querySelector('#editRowId').value),
        unidade: form.querySelector('#editUnidade').value,
        categoria: form.querySelector('#editCategoria').value,
        descricao: form.querySelector('#editDescricao').value,
        marca: form.querySelector('#editMarca').value,
        n_serie: form.querySelector('#editNSerie').value,
        estado: form.querySelector('#editEstado').value
    };

    try {
      const res = await fetch('/api/update_row', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Falha na atualização');
      
      alert('Atualizado com sucesso!');
      editModalInstance.hide();
      
      currentOffset = 0;
      await fetchItems(true);

    } catch (err) {
      handleError('Erro ao salvar: ' + err.message);
    } finally {
      btn.disabled = false;
      spinner.classList.add('d-none');
      btnText.textContent = 'Salvar Alterações';
    }
  }

  // --- EVENT LISTENERS ---
  document.addEventListener('DOMContentLoaded', () => {
    editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));

    document.querySelectorAll('input.filter').forEach(input => input.addEventListener('input', applyFilters));
    document.getElementById('load-more').addEventListener('click', () => {
      if (!hasMoreOnServer) return;
      currentOffset = allItems.length;
      fetchItems();
    });
    document.getElementById('view-all').addEventListener('click', fetchAllItems);
    
    currentOffset = 0;
    fetchItems(true);
  });
</script>
{% endblock %}