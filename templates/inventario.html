{% extends "base.html" %}

{% block title %}Inventário — Últimos registros{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#f7f9fb;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#2563eb;
    --accent-600:#1e40af;
    --border:#e6eef8;
    --danger:#ef4444;
    --radius:8px;
    --small:12px;
  }

  /* container/card */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 20px rgba(2,6,23,0.04)}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .info{color:var(--muted);font-size:14px}

  /* table wrap */
  .table-wrap{overflow:auto;border-radius:6px;border:1px solid var(--border);background:#fff}
  table{width:100%;border-collapse:collapse;min-width:880px;font-family:inherit;font-size:14px}
  colgroup col:nth-child(1){width:60px}
  colgroup col:nth-child(8){width:160px}
  thead th{
    position:sticky;top:0;background:linear-gradient(180deg,#ffffff,#fbfdff);
    z-index:3;text-align:left;padding:10px 12px;font-size:13px;color:#111827;border-bottom:1px solid var(--border);
    white-space:nowrap;
  }

  /* filtro dentro do th */
  thead th .filter-wrap{display:flex;flex-direction:column;gap:6px}
  input.filter{width:100%;padding:6px 8px;border:1px solid #e9f0fb;border-radius:6px;background:#fafcff;font-size:13px;color:#0f172a}

  tbody td{padding:10px 12px;font-size:14px;border-bottom:1px solid #f1f5f9;vertical-align:top;color:#0f172a}
  tbody tr:nth-child(even){background:#fbfdff}
  tbody tr:hover{background:#f7fbff}
  .row-num{color:var(--muted);font-size:13px}

  /* ações */
  .actions .btn{background:var(--accent);color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px}
  .actions .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  .actions .btn.small{padding:4px 8px;font-size:12px;border-radius:6px}
  .actions .btn.delete{background:var(--danger);}

  /* footer / botões */
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .btn-row{display:flex;gap:8px;align-items:center}
  .load-more{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px}
  .disabled{opacity:0.6;pointer-events:none}

  /* responsividade */
  @media (max-width:980px){
    table{min-width:780px}
    colgroup col:nth-child(1){width:48px}
  }
  @media (max-width:720px){
    .controls{flex-direction:column;align-items:stretch}
    table{min-width:650px;font-size:13px}
    thead th, tbody td{padding:8px}
    .btn-row{flex-direction:row}
  }

  /* ajustes visuais opcionais */
  .muted{color:var(--muted);font-size:13px}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="controls">
    <div class="info">Mostrando os últimos <strong id="shown-count">0</strong> de <strong id="total-count">0</strong> itens</div>
    <div style="flex:1"></div>
    <div class="info">Filtros rápidos (cada coluna)</div>
  </div>

  <div class="table-wrap" role="region" aria-label="Tabela de inventário">
    <table id="table-inv">
      <colgroup>
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
      </colgroup>
      <thead>
        <tr id="header-row">
          <th class="row-num">
            Row
          </th>
          <th>
            <div class="filter-wrap">
              <div>Unidade</div>
              <input class="filter" data-col="unidade" placeholder="filtrar unidade...">
            </div>
          </th>
          <th>
            <div class="filter-wrap">
              <div>Categoria</div>
              <input class="filter" data-col="categoria" placeholder="filtrar categoria...">
            </div>
          </th>
          <th>
            <div class="filter-wrap">
              <div>Descrição</div>
              <input class="filter" data-col="descricao" placeholder="filtrar descrição...">
            </div>
          </th>
          <th>
            <div class="filter-wrap">
              <div>Marca</div>
              <input class="filter" data-col="marca" placeholder="filtrar marca...">
            </div>
          </th>
          <th>
            <div class="filter-wrap">
              <div>Nº Série</div>
              <input class="filter" data-col="n_serie" placeholder="filtrar série...">
            </div>
          </th>
          <th>
            <div class="filter-wrap">
              <div>Estado</div>
              <input class="filter" data-col="estado" placeholder="filtrar estado...">
            </div>
          </th>
          <th>
            Timestamp
          </th>
          <th style="width:150px">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody-inv"></tbody>
    </table>
  </div>

  <div class="footer">
    <div class="muted">Dica: use os filtros acima para localizar itens rapidamente</div>
    <div class="btn-row">
      <button id="load-more" class="load-more" style="display:none">Ver mais</button>
      <button id="view-all" class="load-more" style="display:none">Ver toda a tabela</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let items = [];
  let offset = 0;
  const limit = 20;
  let total = 0;
  let has_more = false;
  const MAX_PAGE = 200;

  async function fetchItems(initial = false, useLimit = limit){
    const res = await fetch(`/api/items?offset=${offset}&limit=${useLimit}`);
    if(!res.ok) return alert('Erro ao carregar itens');
    const data = await res.json();
    if(initial) items = data.items || []; else items = items.concat(data.items || []);
    total = data.total || 0;
    has_more = !!data.has_more;
    updateUI();
  }

  async function fetchAll(){
    const btnLoad = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    btnLoad.classList.add('disabled'); btnAll.classList.add('disabled');
    btnAll.textContent = 'Carregando...';
    try {
      let all = [];
      let tempOffset = 0;
      while (true) {
        const res = await fetch(`/api/items?offset=${tempOffset}&limit=${MAX_PAGE}`);
        if(!res.ok) throw new Error('Erro ao carregar página');
        const data = await res.json();
        all = all.concat(data.items || []);
        if(!data.has_more) break;
        tempOffset += MAX_PAGE;
      }
      items = all;
      offset = items.length;
      total = items.length;
      has_more = false;
      // limpa filtros
      document.querySelectorAll('input.filter').forEach(i=>i.value='');
      updateUI();
    } catch (err) {
      alert('Erro ao carregar toda a tabela: ' + err.message);
    } finally {
      btnLoad.classList.remove('disabled'); btnAll.classList.remove('disabled');
      btnAll.textContent = 'Ver toda a tabela';
    }
  }

  function updateUI(){
    renderTable(items);
    document.getElementById('shown-count').textContent = items.length;
    document.getElementById('total-count').textContent = total;
    const btn = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    if(has_more){
      btn.style.display = 'inline-block';
      btnAll.style.display = 'inline-block';
    } else {
      btn.style.display = 'none';
      if(items.length < total) btnAll.style.display = 'inline-block'; else btnAll.style.display = 'none';
    }
  }

  function renderTable(list){
    const tbody = document.getElementById('tbody-inv');
    tbody.innerHTML = '';
    for(const it of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-num">${it.row_number}</td>
        <td>${escapeHtml(it.unidade)}</td>
        <td>${escapeHtml(it.categoria)}</td>
        <td>${escapeHtml(it.descricao)}</td>
        <td>${escapeHtml(it.marca)}</td>
        <td>${escapeHtml(it.n_serie)}</td>
        <td>${escapeHtml(it.estado)}</td>
        <td>${escapeHtml(it.timestamp)}</td>
        <td class="actions"><button class="btn" onclick="editRow(${it.row_number})">Editar</button></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(text){ return (text||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function applyFilters(){
    const filters = document.querySelectorAll('input.filter');
    let filtered = items.slice();
    filters.forEach(f=>{
      const val = f.value.trim().toLowerCase();
      const col = f.dataset.col;
      if(val) filtered = filtered.filter(i => (i[col]||'').toString().toLowerCase().includes(val));
    });
    renderTable(filtered);
  }

  document.addEventListener('input', (e)=>{ if(e.target.matches('input.filter')) applyFilters(); });

  document.getElementById('load-more').addEventListener('click', async ()=>{
    if(!has_more) return;
    offset += limit;
    await fetchItems(false);
  });

  document.getElementById('view-all').addEventListener('click', async ()=>{ await fetchAll(); });

  async function editRow(rowNumber){
    const item = items.find(i=>i.row_number==rowNumber);
    if(!item) return alert('Item não encontrado');
    const unidade = prompt('Unidade', item.unidade) || '';
    const categoria = prompt('Categoria', item.categoria) || '';
    const descricao = prompt('Descrição', item.descricao) || '';
    const marca = prompt('Marca', item.marca) || '';
    const n_serie = prompt('Nº Série', item.n_serie) || '';
    const estado = prompt('Estado', item.estado) || '';

    const payload = { row_number: rowNumber, unidade, categoria, descricao, marca, n_serie, estado };
    const res = await fetch('/api/update_row', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data.success){ alert('Atualizado com sucesso'); offset = 0; await fetchItems(true); }
    else alert('Erro: ' + (data.error || 'falha ao atualizar'));
  }

  (async ()=>{ offset = 0; await fetchItems(true); })();
</script>
{% endblock %}