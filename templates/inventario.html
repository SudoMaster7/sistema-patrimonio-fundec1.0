{% extends "base.html" %}

{% block title %}Inventário — Últimos registros{% endblock %}

{% block head %}
<style>
  /* CORREÇÃO: Adicionamos variáveis para o modo escuro e claro */
  :root {
    --bg: #f6f8fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent-600: #1e40af;
    --border: #e6eef8;
    --danger: #ef4444;
    --radius: 10px;
    --gap: 12px;
    --text: #0f172a;
    --table-header-bg: linear-gradient(180deg, #ffffff, #f8fbff);
    --table-row-even-bg: #fbfdff;
    --table-row-hover-bg: #f3f8ff;
    --input-bg: #fbfeff;
  }

  [data-bs-theme="dark"] {
    --bg: #0d1117;
    --card: #161b22;
    --muted: #848d97;
    --border: #30363d;
    --text: #c9d1d9;
    --table-header-bg: linear-gradient(180deg, #1e242c, #161b22);
    --table-row-even-bg: #1a2028;
    --table-row-hover-bg: #222a34;
    --input-bg: #0d1117;
  }

  body { background: var(--bg); color: var(--text); }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: 0 6px 22px rgba(15, 23, 42, 0.04);
  }

  .controls { display: flex; gap: var(--gap); align-items: center; margin-bottom: 14px; flex-wrap: wrap; }
  .info { color: var(--muted); font-size: 14px; }

  .table-wrap {
    overflow: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card); /* CORREÇÃO: Usar variável */
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 980px;
    font-family: inherit;
    color: var(--text);
  }

  colgroup col:nth-child(1) { width: 68px; }
  colgroup col:nth-child(9) { width: 150px; }

  thead th {
    position: sticky;
    top: 0;
    z-index: 5;
    background: var(--table-header-bg); /* CORREÇÃO: Usar variável */
    padding: 12px 14px;
    font-size: 13px;
    text-align: left;
    color: var(--text); /* CORREÇÃO: Usar variável */
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  thead th .label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
  thead th .filter {
    width: 100%; box-sizing: border-box; padding: 8px 10px; font-size: 13px;
    border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text);
  }

  tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border); /* CORREÇÃO: Usar variável */
    vertical-align: top;
    font-size: 14px;
  }

  tbody tr:nth-child(even) { background: var(--table-row-even-bg); }
  tbody tr:hover { background: var(--table-row-hover-bg); }

  .row-num { color: var(--muted); font-size: 13px; }

  /* O resto do CSS (modal, botões, etc.) está ok e não precisa de grandes mudanças */
  .actions{ display:flex; gap:8px; align-items:center; }
  .actions .btn{ background:var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
  .actions .btn.danger{ background:var(--danger); }
  .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:8px; flex-wrap:wrap; }
  .btn-surface{ background:var(--card); color: var(--text); border:1px solid var(--border); padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
  .btn-primary{ background:var(--accent); color:#fff; border: none; padding:9px 14px; border-radius:8px; cursor:pointer; font-size:14px; }
  .disabled{ opacity:0.6; pointer-events:none; }

  /* Modal Styles */
  .modal-backdrop{ position:fixed; inset:0; background: rgba(2,6,23,0.35); display:none; align-items:center; justify-content:center; z-index:60; }
  .modal-backdrop.show{ display:flex; }
  .modal{ width:100%; max-width:720px; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,0.2); }
  .modal h3{ margin:0 0 12px 0; font-size:18px; color: var(--text); }
  .modal .row{ display:flex; gap:10px; margin-bottom:10px; }
  .modal .row .col{ flex:1; }
  .modal label{ display:block; font-size:13px; margin-bottom:6px; color:var(--muted); }
  .modal input, .modal textarea, .modal select{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); font-size:14px; background: var(--input-bg); color: var(--text); }
  .modal input:disabled { background: var(--bg); }
  .modal .actions-row{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  .modal .btn{ padding:8px 12px; border-radius:8px; cursor:pointer; border: none; }
  .modal .btn.cancel{ background:var(--card); border:1px solid var(--border); color:var(--text); }
  .modal .btn.save{ background:var(--accent); color:#fff; }

</style>
{% endblock %}

{% block content %}
<div class="card" role="region" aria-label="Inventário">
  <div class="controls">
    <div class="info">Mostrando <strong id="shown-count">0</strong> de <strong id="total-count">0</strong> registros</div>
    <div style="flex:1"></div>
    <div class="info">Filtre os dados carregados abaixo</div>
  </div>

  <div class="table-wrap" tabindex="0">
    <table id="table-inv">
      <colgroup><col/><col/><col/><col/><col/><col/><col/><col/><col/></colgroup>
      <thead>
        <tr>
          <th class="row-num"><span class="label">Linha</span></th>
          <th><span class="label">Unidade</span><input class="filter" data-col="unidade" placeholder="Filtrar..."/></th>
          <th><span class="label">Categoria</span><input class="filter" data-col="categoria" placeholder="Filtrar..."/></th>
          <th><span class="label">Descrição</span><input class="filter" data-col="descricao" placeholder="Filtrar..."/></th>
          <th><span class="label">Marca</span><input class="filter" data-col="marca" placeholder="Filtrar..."/></th>
          <th><span class="label">Nº Série</span><input class="filter" data-col="n_serie" placeholder="Filtrar..."/></th>
          <th><span class="label">Estado</span><input class="filter" data-col="estado" placeholder="Filtrar..."/></th>
          <th><span class="label">Timestamp</span></th>
          <th style="width:100px"><span class="label">Ações</span></th>
        </tr>
      </thead>
      <tbody id="tbody-inv">
          </tbody>
    </table>
  </div>

  <div class="footer">
    <div class="muted">Dica: para performance, os filtros funcionam apenas nos dados já carregados.</div>
    <div class="btn-row">
      <button id="load-more" class="btn-surface" style="display:none">Ver mais 20</button>
      <button id="view-all" class="btn-surface" style="display:none">Ver toda a tabela</button>
      <button id="refresh" class="btn-primary" title="Recarregar do início">
          <i class="fa-solid fa-rotate-right"></i> Recarregar
      </button>
    </div>
  </div>
</div>

<div id="edit-modal-back" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="edit-modal-title">
    <h3 id="edit-modal-title">Editar item (Linha <span id="modal-row-num"></span>)</h3>
    <form id="edit-form" onsubmit="return false;">
      <input type="hidden" id="edit-row-number" />
      <div class="row"><div class="col"><label for="edit-unidade">Unidade</label><input id="edit-unidade" type="text"/></div><div class="col"><label for="edit-categoria">Categoria</label><input id="edit-categoria" type="text"/></div></div>
      <div class="row"><div class="col"><label for="edit-descricao">Descrição</label><textarea id="edit-descricao" rows="2"></textarea></div></div>
      <div class="row"><div class="col"><label for="edit-marca">Marca</label><input id="edit-marca" type="text"/></div><div class="col"><label for="edit-nserie">Nº Série</label><input id="edit-nserie" type="text"/></div></div>
      <div class="row"><div class="col"><label for="edit-estado">Estado</label><input id="edit-estado" type="text"/></div><div class="col"><label for="edit-timestamp">Timestamp</label><input id="edit-timestamp" type="text" disabled/></div></div>
      <div class="actions-row">
        <button type="button" class="btn cancel" onclick="closeEditModal()">Cancelar</button>
        <button type="button" class="btn save" onclick="submitEditModal()">Salvar Alterações</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Variáveis de estado globais
  let allItems = [];
  let currentOffset = 0;
  const BATCH_SIZE = 20; // Itens para carregar por vez
  let totalServerCount = 0;
  let hasMoreOnServer = false;

  // MELHORIA: Função de erro centralizada que usa console.error
  function handleError(message, error) {
    console.error(message, error);
    alert(message);
  }

  // Busca inicial e "carregar mais"
  async function fetchItems(isInitialLoad = false) {
    const btnLoad = document.getElementById('load-more');
    btnLoad?.classList.add('disabled');

    try {
      const response = await fetch(`/api/items?offset=${currentOffset}&limit=${BATCH_SIZE}`);
      if (!response.ok) {
        throw new Error(`Erro na API: ${response.statusText}`);
      }
      const data = await response.json();

      if (isInitialLoad) {
        allItems = data.items || [];
      } else {
        allItems = allItems.concat(data.items || []);
      }
      
      totalServerCount = data.total || 0;
      hasMoreOnServer = !!data.has_more;
      
      applyFilters(); // Renderiza a tabela com os filtros atuais
      updateFooter();

    } catch (err) {
      handleError('Não foi possível carregar os itens.', err);
    } finally {
      btnLoad?.classList.remove('disabled');
    }
  }

  // Busca todos os itens da tabela
  async function fetchAllItems() {
    const btnAll = document.getElementById('view-all');
    btnAll.classList.add('disabled');
    btnAll.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Carregando...`;
    
    try {
      // MELHORIA: Busca em lotes maiores para eficiência
      let all = [];
      let tempOffset = 0;
      const MAX_PER_PAGE = 200;
      
      while (true) {
        const res = await fetch(`/api/items?offset=${tempOffset}&limit=${MAX_PER_PAGE}`);
        if(!res.ok) throw new Error('Falha ao carregar uma página de dados.');
        const data = await res.json();
        all = all.concat(data.items || []);
        if(!data.has_more) break;
        tempOffset += MAX_PER_PAGE;
      }
      
      allItems = all;
      currentOffset = allItems.length;
      totalServerCount = allItems.length;
      hasMoreOnServer = false;
      document.querySelectorAll('input.filter').forEach(i => i.value = '');
      
      applyFilters();
      updateFooter();

    } catch (err) {
      handleError('Erro ao carregar a tabela completa.', err);
    } finally {
      btnAll.classList.remove('disabled');
      btnAll.innerHTML = 'Ver toda a tabela';
    }
  }
  
  function updateFooter() {
    document.getElementById('total-count').textContent = totalServerCount;
    const btnLoad = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    
    if (hasMoreOnServer) {
        btnLoad.style.display = 'inline-block';
        btnAll.style.display = 'inline-block';
    } else {
        btnLoad.style.display = 'none';
        // Mostra o botão "Ver tudo" se ainda houver itens não carregados
        btnAll.style.display = allItems.length < totalServerCount ? 'inline-block' : 'none';
    }
  }

  function renderTable(list) {
    const tbody = document.getElementById('tbody-inv');
    tbody.innerHTML = ''; // Limpa a tabela
    document.getElementById('shown-count').textContent = list.length;
    
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 20px;">Nenhum item encontrado.</td></tr>';
        return;
    }

    // Usando DocumentFragment para melhor performance
    const fragment = document.createDocumentFragment();
    for (const item of list) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-num">${item.row_number}</td>
        <td>${escapeHtml(item.unidade)}</td>
        <td>${escapeHtml(item.categoria)}</td>
        <td>${escapeHtml(item.descricao)}</td>
        <td>${escapeHtml(item.marca)}</td>
        <td>${escapeHtml(item.n_serie)}</td>
        <td>${escapeHtml(item.estado)}</td>
        <td>${escapeHtml(item.timestamp)}</td>
        <td class="actions"><button class="btn" onclick="openEditModal(${item.row_number})">Editar</button></td>
      `;
      fragment.appendChild(tr);
    }
    tbody.appendChild(fragment);
  }

  function escapeHtml(text) { return (text || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  function applyFilters() {
    const filters = Array.from(document.querySelectorAll('input.filter'));
    let filteredItems = allItems;

    for (const f of filters) {
        const value = f.value.trim().toLowerCase();
        const col = f.dataset.col;
        if (value) {
            filteredItems = filteredItems.filter(item => 
                (item[col] || '').toString().toLowerCase().includes(value)
            );
        }
    }
    renderTable(filteredItems);
  }
  
  // --- Event Listeners ---
  document.addEventListener('input', (e) => { if (e.target.matches('input.filter')) applyFilters(); });
  document.getElementById('load-more').addEventListener('click', () => { if (!hasMoreOnServer) return; currentOffset += BATCH_SIZE; fetchItems(); });
  document.getElementById('view-all').addEventListener('click', fetchAllItems);
  document.getElementById('refresh').addEventListener('click', () => { currentOffset = 0; fetchItems(true); });

  // --- Modal Functions ---
  function openEditModal(rowNumber) {
    const item = allItems.find(i => i.row_number === rowNumber);
    if (!item) return handleError('Item não encontrado na lista local.');
    
    document.getElementById('edit-row-number').value = item.row_number;
    document.getElementById('modal-row-num').textContent = item.row_number;
    document.getElementById('edit-unidade').value = item.unidade || '';
    document.getElementById('edit-categoria').value = item.categoria || '';
    document.getElementById('edit-descricao').value = item.descricao || '';
    document.getElementById('edit-marca').value = item.marca || '';
    document.getElementById('edit-nserie').value = item.n_serie || '';
    document.getElementById('edit-estado').value = item.estado || '';
    document.getElementById('edit-timestamp').value = item.timestamp || '';

    const backdrop = document.getElementById('edit-modal-back');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden', 'false');
    setTimeout(() => document.getElementById('edit-unidade').focus(), 100);
  }

  function closeEditModal() {
    const backdrop = document.getElementById('edit-modal-back');
    backdrop.classList.remove('show');
    backdrop.setAttribute('aria-hidden', 'true');
  }

  async function submitEditModal() {
    const btn = document.querySelector('.modal .btn.save');
    btn.classList.add('disabled');
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`;

    const payload = {
      row_number: Number(document.getElementById('edit-row-number').value),
      unidade: document.getElementById('edit-unidade').value.trim(),
      categoria: document.getElementById('edit-categoria').value.trim(),
      descricao: document.getElementById('edit-descricao').value.trim(),
      marca: document.getElementById('edit-marca').value.trim(),
      n_serie: document.getElementById('edit-nserie').value.trim(),
      estado: document.getElementById('edit-estado').value.trim()
    };
    if (!payload.row_number) return handleError('Número da linha inválido.');

    try {
      const response = await fetch('/api/update_row', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Erro do servidor');

      // MELHORIA: Simplifica a atualização recarregando os dados. É mais confiável.
      await fetchItems(true); // Recarrega a primeira página
      closeEditModal();
      alert('Item atualizado com sucesso!');

    } catch (err) {
      handleError('Não foi possível salvar as alterações.', err);
    } finally {
        btn.classList.remove('disabled');
        btn.innerHTML = 'Salvar Alterações';
    }
  }
  
  // Close modal on backdrop click or escape key
  document.getElementById('edit-modal-back').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeEditModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeEditModal(); });

  // Initial data load
  fetchItems(true);
</script>
{% endblock %}