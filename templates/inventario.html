{% extends "base.html" %}

{% block title %}Inventário — Últimos registros{% endblock %}

{% block head %}
<style>
  :root{
    --bg: #f6f8fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent-600: #1e40af;
    --border: #e6eef8;
    --danger: #ef4444;
    --radius: 10px;
    --gap: 12px;
    --text: #0f172a;
  }

  body { background: var(--bg); }

  .card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: 0 6px 22px rgba(15,23,42,0.04);
  }

  .controls{ display:flex; gap:var(--gap); align-items:center; margin-bottom:14px; flex-wrap:wrap; }
  .info{ color:var(--muted); font-size:14px; }

  .table-wrap{
    overflow:auto;
    border-radius:8px;
    border:1px solid var(--border);
    background: linear-gradient(180deg,#fff,#fbfdff);
  }

  table{
    width:100%;
    border-collapse:collapse;
    min-width:980px;
    font-family:inherit;
    color:var(--text);
  }

  colgroup col:nth-child(1){ width:68px; }
  colgroup col:nth-child(9){ width:150px; }

  thead th{
    position: sticky;
    top: 0;
    z-index: 5;
    background: linear-gradient(180deg,#ffffff,#f8fbff);
    padding:12px 14px;
    font-size:13px;
    text-align:left;
    color:#0b1220;
    border-bottom:1px solid var(--border);
    white-space:nowrap;
  }

  thead th .label { display:block; font-weight:600; margin-bottom:6px; font-size:13px; }
  thead th .filter{ width:100%; box-sizing:border-box; padding:8px 10px; font-size:13px; border:1px solid #e9f0fb; border-radius:8px; background:#fbfeff; color:var(--text); }

  tbody td{
    padding:12px 14px;
    border-bottom:1px solid #f1f5f9;
    vertical-align:top;
    font-size:14px;
  }

  tbody tr:nth-child(even){ background:#fbfdff; }
  tbody tr:hover{ background:#f3f8ff; }

  .row-num{ color:var(--muted); font-size:13px; }

  .actions{ display:flex; gap:8px; align-items:center; }
  .actions .btn{
    background:var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px;
  }
  .actions .btn.secondary{ background:#fff; color:var(--accent); border:1px solid var(--accent); }
  .actions .btn.danger{ background:var(--danger); }

  .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:8px; flex-wrap:wrap; }
  .btn-row{ display:flex; gap:8px; }
  .btn-surface{
    background:#fff; border:1px solid var(--border); padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px;
  }
  .btn-primary{ background:var(--accent); color:#fff; border: none; padding:9px 14px; border-radius:8px; cursor:pointer; font-size:14px; }

  .disabled{ opacity:0.6; pointer-events:none; }

  @media (max-width:980px){
    table{ min-width:820px; }
    thead th, tbody td { padding:10px; font-size:13px; }
    colgroup col:nth-child(1){ width:56px; }
  }
  @media (max-width:720px){
    .controls{ flex-direction:column; align-items:stretch; gap:8px; }
    .footer{ flex-direction:column-reverse; align-items:stretch; }
    .btn-row{ justify-content:flex-end; }
    table{ min-width:700px; }
  }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background: rgba(2,6,23,0.35); display:none; align-items:center; justify-content:center; z-index:60;
  }
  .modal-backdrop.show{ display:flex; }
  .modal{
    width:100%; max-width:720px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,0.2);
  }
  .modal h3{ margin:0 0 12px 0; font-size:18px; }
  .modal .row{ display:flex; gap:10px; margin-bottom:10px; }
  .modal .row .col{ flex:1; }
  .modal label{ display:block; font-size:13px; margin-bottom:6px; color:var(--muted); }
  .modal input[type="text"], .modal textarea, .modal select{
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e9f0fb; font-size:14px;
  }
  .modal .actions-row{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  .modal .btn{ padding:8px 12px; border-radius:8px; cursor:pointer; border: none; }
  .modal .btn.cancel{ background:#fff; border:1px solid var(--border); color:var(--text); }
  .modal .btn.save{ background:var(--accent); color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="card" role="region" aria-label="Inventário">
  <div class="controls">
    <div class="info">Mostrando os últimos <strong id="shown-count">0</strong> de <strong id="total-count">0</strong></div>
    <div style="flex:1"></div>
    <div class="info">Use os filtros para buscar por coluna</div>
  </div>

  <div class="table-wrap" tabindex="0">
    <table id="table-inv" aria-describedby="table-desc">
      <colgroup>
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
        <col />
      </colgroup>
      <thead>
        <tr>
          <th class="row-num"><span class="label">Row</span></th>

          <th>
            <span class="label">Unidade</span>
            <input class="filter" data-col="unidade" placeholder="filtrar unidade..." />
          </th>

          <th>
            <span class="label">Categoria</span>
            <input class="filter" data-col="categoria" placeholder="filtrar categoria..." />
          </th>

          <th>
            <span class="label">Descrição</span>
            <input class="filter" data-col="descricao" placeholder="filtrar descrição..." />
          </th>

          <th>
            <span class="label">Marca</span>
            <input class="filter" data-col="marca" placeholder="filtrar marca..." />
          </th>

          <th>
            <span class="label">Nº Série</span>
            <input class="filter" data-col="n_serie" placeholder="filtrar série..." />
          </th>

          <th>
            <span class="label">Estado</span>
            <input class="filter" data-col="estado" placeholder="filtrar estado..." />
          </th>

          <th><span class="label">Timestamp</span></th>
          <th style="width:160px"><span class="label">Ações</span></th>
        </tr>
      </thead>
      <tbody id="tbody-inv"></tbody>
    </table>
  </div>

  <div class="footer" aria-hidden="false">
    <div class="muted">Dica: filtros funcionam nas colunas carregadas</div>
    <div class="btn-row">
      <button id="load-more" class="btn-surface" style="display:none">Ver mais</button>
      <button id="view-all" class="btn-surface" style="display:none">Ver toda a tabela</button>
      <button id="refresh" class="btn-primary" title="Recarregar">Recarregar</button>
    </div>
  </div>
</div>

<!-- Modal de edição -->
<div id="edit-modal-back" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="edit-modal-title">
    <h3 id="edit-modal-title">Editar item</h3>
    <form id="edit-form" onsubmit="return false;">
      <input type="hidden" id="edit-row-number" />
      <div class="row">
        <div class="col">
          <label for="edit-unidade">Unidade</label>
          <input id="edit-unidade" type="text" />
        </div>
        <div class="col">
          <label for="edit-categoria">Categoria</label>
          <input id="edit-categoria" type="text" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit-descricao">Descrição</label>
          <textarea id="edit-descricao" rows="2"></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit-marca">Marca</label>
          <input id="edit-marca" type="text" />
        </div>
        <div class="col">
          <label for="edit-nserie">Nº Série</label>
          <input id="edit-nserie" type="text" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit-estado">Estado</label>
          <input id="edit-estado" type="text" />
        </div>
        <div class="col">
          <label for="edit-timestamp">Timestamp</label>
          <input id="edit-timestamp" type="text" disabled />
        </div>
      </div>

      <div class="actions-row">
        <button type="button" class="btn cancel" onclick="closeEditModal()">Cancelar</button>
        <button type="button" class="btn save" onclick="submitEditModal()">Salvar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let items = [];
  let offset = 0;
  const limit = 20;
  let total = 0;
  let has_more = false;
  const MAX_PAGE = 200;

  function showError(msg){ alert(msg); }

  async function fetchItems(initial = false, useLimit = limit){
    const btnLoad = document.getElementById('load-more');
    btnLoad?.classList.add('disabled');
    try {
      const res = await fetch(`/api/items?offset=${offset}&limit=${useLimit}`);
      if(!res.ok) { showError('Erro ao carregar itens'); return; }
      const data = await res.json();
      if(initial) items = data.items || []; else items = items.concat(data.items || []);
      total = data.total || 0;
      has_more = !!data.has_more;
      updateUI();
    } catch (err) {
      showError('Erro: ' + err.message);
    } finally {
      btnLoad?.classList.remove('disabled');
    }
  }

  async function fetchAll(){
    const btnLoad = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    btnLoad.classList.add('disabled'); btnAll.classList.add('disabled'); btnAll.textContent = 'Carregando...';
    try {
      let all = [];
      let tempOffset = 0;
      while (true) {
        const res = await fetch(`/api/items?offset=${tempOffset}&limit=${MAX_PAGE}`);
        if(!res.ok) throw new Error('Erro ao carregar página');
        const data = await res.json();
        all = all.concat(data.items || []);
        if(!data.has_more) break;
        tempOffset += MAX_PAGE;
      }
      items = all;
      offset = items.length;
      total = items.length;
      has_more = false;
      document.querySelectorAll('input.filter').forEach(i=>i.value='');
      updateUI();
    } catch (err) {
      showError('Erro ao carregar toda a tabela: ' + err.message);
    } finally {
      btnLoad.classList.remove('disabled'); btnAll.classList.remove('disabled'); btnAll.textContent = 'Ver toda a tabela';
    }
  }

  function updateUI(){
    renderTable(items);
    document.getElementById('shown-count').textContent = items.length;
    document.getElementById('total-count').textContent = total;
    const btn = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    if(has_more){
      btn.style.display = 'inline-block';
      btnAll.style.display = 'inline-block';
    } else {
      btn.style.display = 'none';
      btnAll.style.display = items.length < total ? 'inline-block' : 'none';
    }
  }

  function renderTable(list){
    const tbody = document.getElementById('tbody-inv');
    tbody.innerHTML = '';
    for(const it of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-num">${it.row_number}</td>
        <td>${escapeHtml(it.unidade)}</td>
        <td>${escapeHtml(it.categoria)}</td>
        <td>${escapeHtml(it.descricao)}</td>
        <td>${escapeHtml(it.marca)}</td>
        <td>${escapeHtml(it.n_serie)}</td>
        <td>${escapeHtml(it.estado)}</td>
        <td>${escapeHtml(it.timestamp)}</td>
        <td class="actions"><button class="btn" onclick="openEditModal(${it.row_number})">Editar</button></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(text){ return (text||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function applyFilters(){
    const filters = document.querySelectorAll('input.filter');
    let filtered = items.slice();
    filters.forEach(f=>{
      const val = f.value.trim().toLowerCase();
      const col = f.dataset.col;
      if(val) filtered = filtered.filter(i => (i[col]||'').toString().toLowerCase().includes(val));
    });
    renderTable(filtered);
  }

  document.addEventListener('input', (e)=>{ if(e.target.matches('input.filter')) applyFilters(); });

  document.getElementById('load-more').addEventListener('click', async ()=>{
    if(!has_more) return;
    offset += limit;
    await fetchItems(false);
  });

  document.getElementById('view-all').addEventListener('click', async ()=>{ await fetchAll(); });

  document.getElementById('refresh').addEventListener('click', async ()=>{
    offset = 0;
    await fetchItems(true);
  });

  /* Modal functions */
  function openEditModal(rowNumber){
    const item = items.find(i => Number(i.row_number) === Number(rowNumber));
    if(!item) return showError('Item não encontrado');
    document.getElementById('edit-row-number').value = item.row_number;
    document.getElementById('edit-unidade').value = item.unidade || '';
    document.getElementById('edit-categoria').value = item.categoria || '';
    document.getElementById('edit-descricao').value = item.descricao || '';
    document.getElementById('edit-marca').value = item.marca || '';
    document.getElementById('edit-nserie').value = item.n_serie || '';
    document.getElementById('edit-estado').value = item.estado || '';
    document.getElementById('edit-timestamp').value = item.timestamp || '';
    const back = document.getElementById('edit-modal-back');
    back.classList.add('show');
    back.setAttribute('aria-hidden', 'false');
    // focus first input
    setTimeout(()=>document.getElementById('edit-unidade').focus(), 100);
  }

  function closeEditModal(){
    const back = document.getElementById('edit-modal-back');
    back.classList.remove('show');
    back.setAttribute('aria-hidden', 'true');
  }

  async function submitEditModal(){
    const rowNumber = document.getElementById('edit-row-number').value;
    const payload = {
      row_number: Number(rowNumber),
      unidade: document.getElementById('edit-unidade').value.trim(),
      categoria: document.getElementById('edit-categoria').value.trim(),
      descricao: document.getElementById('edit-descricao').value.trim(),
      marca: document.getElementById('edit-marca').value.trim(),
      n_serie: document.getElementById('edit-nserie').value.trim(),
      estado: document.getElementById('edit-estado').value.trim()
    };
    // basic validation
    if(!payload.row_number) return showError('Row inválido');
    try {
      const res = await fetch('/api/update_row', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(res.ok && data.success){
        // atualiza item na lista local e re-renderiza (sem recarregar tudo)
        const idx = items.findIndex(i => Number(i.row_number) === Number(payload.row_number));
        if(idx !== -1){
          items[idx].unidade = payload.unidade;
          items[idx].categoria = payload.categoria;
          items[idx].descricao = payload.descricao;
          items[idx].marca = payload.marca;
          items[idx].n_serie = payload.n_serie;
          items[idx].estado = payload.estado;
          // timestamp será atualizado pelo servidor; recarregar pequeno trecho para garantir
          await fetchItems(true);
        } else {
          await fetchItems(true);
        }
        closeEditModal();
        alert('Atualizado com sucesso');
      } else {
        showError('Erro ao atualizar: ' + (data.error || res.statusText));
      }
    } catch (err) {
      showError('Erro ao atualizar: ' + err.message);
    }
  }

  // close modal when clicking backdrop
  document.getElementById('edit-modal-back').addEventListener('click', (e)=>{
    if(e.target === e.currentTarget) closeEditModal();
  });

  // keyboard escape to close
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeEditModal();
  });

  (async ()=>{ offset = 0; await fetchItems(true); })();
</script>
{% endblock %}