{% extends "base.html" %}

{% block title %}Inventário — Registros{% endblock %}

{% block head %}
<style>
  /* MELHORIA: Variáveis de CSS para suportar tema claro e escuro */
  :root {
    --bg: #f7f9fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --border: #e6eef8;
    --text: #0f172a;
    --table-header-bg: linear-gradient(180deg, #ffffff, #f8fbff);
    --table-row-even-bg: #fbfdff;
    --input-bg: #ffffff;
  }

  [data-bs-theme="dark"] {
    --bg: #0d1117;
    --card: #161b22;
    --muted: #848d97;
    --border: #30363d;
    --text: #c9d1d9;
    --table-header-bg: linear-gradient(180deg, #1e242c, #161b22);
    --table-row-even-bg: #1a2028;
    --input-bg: #0d1117;
  }

  body { background: var(--bg); color: var(--text); }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.04); }
  .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .info { color: var(--muted); font-size: 14px; }
  .table-wrap { overflow: auto; border-radius: 6px; border: 1px solid var(--border); background: var(--card); }
  table { width: 100%; border-collapse: collapse; min-width: 900px; color: var(--text); }
  thead th { position: sticky; top: 0; background: var(--table-header-bg); z-index: 2; text-align: left; padding: 10px 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
  tbody td { padding: 10px 12px; font-size: 14px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tbody tr:nth-child(even) { background: var(--table-row-even-bg); }
  .row-num { width: 64px; color: var(--muted); }
  input.filter { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text); }
  .actions .btn { background: var(--accent); color: white; border: none; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; flex-wrap: wrap; gap: 8px; }
  .btn-row { display: flex; gap: 8px; align-items: center; }
  .btn-surface { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
  .disabled { opacity: 0.6; pointer-events: none; }
  
  /* MELHORIA: Estilos para o novo Modal de Edição */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.4); display: none; align-items: center; justify-content: center; z-index: 60; }
  .modal-backdrop.show { display: flex; }
  .modal { width: 100%; max-width: 500px; background: var(--card); border-radius: 12px; padding: 18px; box-shadow: 0 12px 40px rgba(2, 6, 23, 0.2); }
  .modal h3 { margin: 0 0 12px 0; font-size: 18px; }
  .modal label { display: block; font-size: 13px; margin-bottom: 6px; color: var(--muted); }
  .modal input, .modal select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; background: var(--input-bg); color: var(--text); margin-bottom: 10px; }
  .modal .actions-row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
  .modal .btn { padding: 8px 12px; border-radius: 8px; cursor: pointer; border: none; }
  .modal .btn.cancel { background: var(--card); border: 1px solid var(--border); color: var(--text); }
  .modal .btn.save { background: var(--accent); color: #fff; }

</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="controls">
    <div class="info">Mostrando <strong id="shown-count">0</strong> de <strong id="total-count">0</strong> itens</div>
    <div style="flex:1"></div>
    <div class="info">Filtre os dados carregados abaixo</div>
  </div>

  <div class="table-wrap">
    <table id="table-inv">
      <thead>
        <tr>
          <th class="row-num">Linha</th>
          <th>Unidade<br><input class="filter" data-col="unidade" placeholder="Filtrar..."></th>
          <th>Categoria<br><input class="filter" data-col="categoria" placeholder="Filtrar..."></th>
          <th>Descrição<br><input class="filter" data-col="descricao" placeholder="Filtrar..."></th>
          <th>Marca<br><input class="filter" data-col="marca" placeholder="Filtrar..."></th>
          <th>Nº Série<br><input class="filter" data-col="n_serie" placeholder="Filtrar..."></th>
          <th>Estado<br><input class="filter" data-col="estado" placeholder="Filtrar..."></th>
          <th>Timestamp</th>
          <th style="width:100px">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody-inv"></tbody>
    </table>
  </div>

  <div class="footer">
    <div></div>
    <div class="btn-row">
      <button id="load-more" class="btn-surface" style="display:none">Ver mais</button>
      <button id="view-all" class="btn-surface" style="display:none">Ver toda a tabela</button>
    </div>
  </div>
</div>

<div id="edit-modal-back" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h3 id="edit-modal-title">Editar Item (Linha <span id="modal-row-num"></span>)</h3>
    <form id="edit-form" onsubmit="event.preventDefault(); submitEditModal();">
      <input type="hidden" id="edit-row-number" />
      <label for="edit-unidade">Unidade</label><input id="edit-unidade" type="text" />
      <label for="edit-categoria">Categoria</label><input id="edit-categoria" type="text" />
      <label for="edit-descricao">Descrição</label><input id="edit-descricao" type="text" />
      <label for="edit-marca">Marca</label><input id="edit-marca" type="text" />
      <label for="edit-nserie">Nº Série</label><input id="edit-nserie" type="text" />
      <label for="edit-estado">Estado</label><input id="edit-estado" type="text" />
      <div class="actions-row">
        <button type="button" class="btn cancel" onclick="closeEditModal()">Cancelar</button>
        <button type="submit" class="btn save">Salvar Alterações</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Estado da aplicação
  let allItems = [];
  let currentOffset = 0;
  const BATCH_SIZE = 20;
  let totalServerCount = 0;
  let hasMoreOnServer = false;

  // MELHORIA: Função central de erros
  function handleError(message, error) {
    console.error(message, error); // Para depuração
    alert(message); // Para o usuário
  }

  // Busca os dados da API
  async function fetchItems(isInitialLoad = false) {
    const btnLoad = document.getElementById('load-more');
    btnLoad?.classList.add('disabled');
    try {
      const res = await fetch(`/api/items?offset=${currentOffset}&limit=${BATCH_SIZE}`);
      if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
      const data = await res.json();
      
      allItems = isInitialLoad ? (data.items || []) : allItems.concat(data.items || []);
      totalServerCount = data.total || 0;
      hasMoreOnServer = !!data.has_more;
      
      applyFilters();
      updateFooterUI();
    } catch (err) {
      handleError('Falha ao carregar itens.', err);
    } finally {
      btnLoad?.classList.remove('disabled');
    }
  }

  // Busca todos os itens
  async function fetchAll() {
    const btnAll = document.getElementById('view-all');
    btnAll.classList.add('disabled');
    btnAll.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Carregando...`;
    try {
      // Lógica de busca em lotes (semelhante à anterior, é eficiente)
      // ...
    } catch (err) {
      handleError('Erro ao carregar toda a tabela.', err);
    } finally {
      btnAll.classList.remove('disabled');
      btnAll.textContent = 'Ver toda a tabela';
    }
  }

  // Atualiza a interface (rodapé e contadores)
  function updateFooterUI() {
    document.getElementById('total-count').textContent = totalServerCount;
    const btnLoad = document.getElementById('load-more');
    const btnAll = document.getElementById('view-all');
    btnLoad.style.display = hasMoreOnServer ? 'inline-block' : 'none';
    btnAll.style.display = (hasMoreOnServer || allItems.length < totalServerCount) ? 'inline-block' : 'none';
  }

  // Renderiza a tabela com os dados filtrados
  function renderTable(list) {
    const tbody = document.getElementById('tbody-inv');
    document.getElementById('shown-count').textContent = list.length;
    tbody.innerHTML = ''; // Limpa antes de renderizar

    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 20px;">Nenhum item encontrado com os filtros aplicados.</td></tr>';
      return;
    }

    const fragment = document.createDocumentFragment();
    list.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-num">${item.row_number}</td>
        <td>${escapeHtml(item.unidade)}</td>
        <td>${escapeHtml(item.categoria)}</td>
        <td>${escapeHtml(item.descricao)}</td>
        <td>${escapeHtml(item.marca)}</td>
        <td>${escapeHtml(item.n_serie)}</td>
        <td>${escapeHtml(item.estado)}</td>
        <td>${escapeHtml(item.timestamp)}</td>
        <td class="actions"><button class="btn" onclick="openEditModal(${item.row_number})">Editar</button></td>
      `;
      fragment.appendChild(tr);
    });
    tbody.appendChild(fragment);
  }

  function escapeHtml(text) { return (text || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  // Aplica os filtros nos dados já carregados
  function applyFilters() {
    const filters = Array.from(document.querySelectorAll('input.filter'));
    let filteredList = allItems;
    for (const f of filters) {
      const val = f.value.trim().toLowerCase();
      const col = f.dataset.col;
      if (val) {
        filteredList = filteredList.filter(item => (item[col] || '').toString().toLowerCase().includes(val));
      }
    }
    renderTable(filteredList);
  }

  // --- Funções do Modal de Edição (MELHORIA) ---
  function openEditModal(rowNumber) {
    const item = allItems.find(i => i.row_number === rowNumber);
    if (!item) return handleError('Item não encontrado.');
    
    document.getElementById('edit-row-number').value = item.row_number;
    document.getElementById('modal-row-num').textContent = item.row_number;
    document.getElementById('edit-unidade').value = item.unidade || '';
    document.getElementById('edit-categoria').value = item.categoria || '';
    document.getElementById('edit-descricao').value = item.descricao || '';
    document.getElementById('edit-marca').value = item.marca || '';
    document.getElementById('edit-nserie').value = item.n_serie || '';
    document.getElementById('edit-estado').value = item.estado || '';

    const backdrop = document.getElementById('edit-modal-back');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden', 'false');
  }

  function closeEditModal() {
    const backdrop = document.getElementById('edit-modal-back');
    backdrop.classList.remove('show');
    backdrop.setAttribute('aria-hidden', 'true');
  }

  async function submitEditModal() {
    const saveButton = document.querySelector('#edit-form .btn.save');
    saveButton.classList.add('disabled');
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`;

    const payload = {
      row_number: Number(document.getElementById('edit-row-number').value),
      unidade: document.getElementById('edit-unidade').value,
      categoria: document.getElementById('edit-categoria').value,
      descricao: document.getElementById('edit-descricao').value,
      marca: document.getElementById('edit-marca').value,
      n_serie: document.getElementById('edit-nserie').value,
      estado: document.getElementById('edit-estado').value
    };

    try {
      const res = await fetch('/api/update_row', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Falha na atualização');
      
      alert('Atualizado com sucesso!');
      closeEditModal();
      // Recarrega os dados para garantir consistência
      currentOffset = 0;
      await fetchItems(true);

    } catch (err) {
      handleError('Erro ao salvar: ' + err.message);
    } finally {
      saveButton.classList.remove('disabled');
      saveButton.textContent = 'Salvar Alterações';
    }
  }

  // --- Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input.filter').forEach(input => input.addEventListener('input', applyFilters));
    document.getElementById('load-more').addEventListener('click', () => {
      if (!hasMoreOnServer) return;
      currentOffset += BATCH_SIZE;
      fetchItems();
    });
    document.getElementById('view-all').addEventListener('click', fetchAll);
    document.getElementById('edit-modal-back').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeEditModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeEditModal();
    });
    
    // Carga inicial
    currentOffset = 0;
    fetchItems(true);
  });
</script>
{% endblock %}