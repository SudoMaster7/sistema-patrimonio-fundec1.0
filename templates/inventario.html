<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Inventário</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f4f4f4; position: sticky; top: 0; }
    input.filter { width: 100%; box-sizing: border-box; }
    .btn { padding: 4px 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Inventário</h1>

  <p>Use os filtros em cada coluna para buscar. Clique em "Editar" para alterar a linha sem abrir o Google Sheets.</p>

  <table id="table-inv">
    <thead>
      <tr id="header-row">
        <th>Row</th>
        <th>Unidade<br><input class="filter" data-col="unidade" placeholder="filtrar..."></th>
        <th>Categoria<br><input class="filter" data-col="categoria" placeholder="filtrar..."></th>
        <th>Descrição<br><input class="filter" data-col="descricao" placeholder="filtrar..."></th>
        <th>Marca<br><input class="filter" data-col="marca" placeholder="filtrar..."></th>
        <th>Nº Série<br><input class="filter" data-col="n_serie" placeholder="filtrar..."></th>
        <th>Estado<br><input class="filter" data-col="estado" placeholder="filtrar..."></th>
        <th>Timestamp</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tbody-inv"></tbody>
  </table>

  <script>
    let items = [];

    async function fetchItems(){
      const res = await fetch('/api/items');
      const data = await res.json();
      items = data.items || [];
      renderTable(items);
    }

    function renderTable(list){
      const tbody = document.getElementById('tbody-inv');
      tbody.innerHTML = '';
      for(const it of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.row_number}</td>
          <td>${escapeHtml(it.unidade)}</td>
          <td>${escapeHtml(it.categoria)}</td>
          <td>${escapeHtml(it.descricao)}</td>
          <td>${escapeHtml(it.marca)}</td>
          <td>${escapeHtml(it.n_serie)}</td>
          <td>${escapeHtml(it.estado)}</td>
          <td>${escapeHtml(it.timestamp)}</td>
          <td><button class="btn" data-row="${it.row_number}" onclick="editRow(${it.row_number})">Editar</button></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(text){ return (text||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function applyFilters(){
      const filters = document.querySelectorAll('input.filter');
      let filtered = items.slice();
      filters.forEach(f=>{
        const val = f.value.trim().toLowerCase();
        const col = f.dataset.col;
        if(val){
          filtered = filtered.filter(i => (i[col]||'').toString().toLowerCase().includes(val));
        }
      });
      renderTable(filtered);
    }

    document.addEventListener('input', (e)=>{
      if(e.target.matches('input.filter')) applyFilters();
    });

    async function editRow(rowNumber){
      // Busca item atual
      const item = items.find(i=>i.row_number==rowNumber);
      if(!item) return alert('Item não encontrado');

      // Simples prompt para cada campo (pode trocar por modal)
      const unidade = prompt('Unidade', item.unidade) || '';
      const categoria = prompt('Categoria', item.categoria) || '';
      const descricao = prompt('Descrição', item.descricao) || '';
      const marca = prompt('Marca', item.marca) || '';
      const n_serie = prompt('Nº Série', item.n_serie) || '';
      const estado = prompt('Estado', item.estado) || '';

      const payload = {
        row_number: rowNumber,
        unidade, categoria, descricao, marca, n_serie, estado
      };

      const res = await fetch('/api/update_row', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if(res.ok && data.success){
        alert('Atualizado com sucesso');
        await fetchItems();
      } else {
        alert('Erro: ' + (data.error || 'falha ao atualizar'));
      }
    }

    // Carrega itens ao abrir
    fetchItems();
  </script>
</body>
</html>